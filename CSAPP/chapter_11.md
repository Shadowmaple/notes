# 第十一章 网络编程

# 客户端—服务器编程模型

每个网络应用都是基于客户端—服务器模型的。一个应用是由一个服务器进程和一个或多个客户端进程组成的。服务器管理某种资源，并通过操作这种资源为其客户端提供某种服务。

客户端—服务器模型中的基本操作是事务。一个客户端—服务器事务由以下四步组成：

1.  当一个客户端需要服务时，它向服务器发送一个请求，发起一个事务。
2.  服务器收到请求后，解析它，并以适当的方式操作它的资源。
3.  服务器向客户端发送一个响应，并等待下一个请求。
4.  客户端收到响应并进行处理。

在一个网络的上下文中，事务仅仅是客户端和服务器执行的一系列步骤。

客户端和服务器是进程，而非某种机器或主机。

# 网络

客户端和服务器通常运行在不同的主机上，并通过计算机网络的硬件和软件资源来进行通信。

对主机而言，网络只是一种I/O设备，是数据源和数据接收方。一个插到I/O总线扩展槽的适配器提供了到达网络的物理接口。

适配器，即接口转换器。

物理上而言，网络是一个按照地理远近组成的层次系统。最底层是**LAN**（Local Area Network），即**局域网**。迄今为止，最流行的局域网技术是**以太网**（Ethernet），以太网是一种局域网。

一个以太网段包括一些电缆（通常是双绞线）和一个**集线器**。电缆连接主机的适配器和集线器的一个端口。集线器对从一个端口上接收到的每个位（数据）都会不加分辨地复制到其它所有端口上，即会将一台主机发送的数据广播到该以太网段的所有主机上。每台主机都能看到每个位。每条电缆的带宽是相同的。

每个以太网适配器都有一个全球唯一的48位地址，它存储在这个适配器的非易失性存储器上。一台主机可以发送一段位（帧）到这个网段内的其它任何主机。每个主机适配器都可以看到这个帧，但只有目的主机能实际读取它。

一个帧由一些固定数量的**头部（header）**（标识来源地址，目的地址和帧的长度）和数据位的**有效载荷（payload）**组成。

使用一个名为网桥的小盒子，可以将多个以太网段连接成一个较大的局域网，这种使用网桥方式形成的局域网被称为**桥接以太网**。在这个桥接以太网中，电缆的带宽可以是不同的。

网桥比集线器更加充分地利用了电缆带宽。它们可以随着时间自动学习哪个主机可以通过哪个端口可达，然后只在有必要时，有选择地将帧从一个端口复制到另一个端口。

例如，如果主机A发送一个帧到同网段上的主机B，当该帧到达网桥X的输入端口时，X就将其丢弃，因而节省了其它网段上的带宽。

多个路由器可以形成点到点的连接，形成WAN（Wide-Area Network），即广域网。广域网相比较局域网，只是覆盖的地理范围更大而已。

路由器可以将多个不兼容的局域网或广域网连接起来，组成一个internet（互联网络）。



互联网络至关重要的特性是，它能由采用完全不同和不兼容技术的各种局域网和广域网组成。

每台主机和其它主机都是物理相连的，主机在不兼容网络之间的数据传送是通过一层运行在每台主机和路由器上的协议软件的，它消除了不同网络之间的差异。

协议必备的两项基本能力：

+   命名机制。互联网协议通过定义一种一致的主机地址格式消除不同局域网技术所带来的差异。每台主机被分配至少一个互联网地址，其唯一标识了这台主机。
+   传送机制。使用一种把数据位捆扎成不连续的片（称为包）的统一方式进行传送。

不同局域网间的主机的数据传送步骤：

1.  运行在主机A上的客户端进行一个系统调用，从客户端的虚拟地址空间复制数据到内核缓冲区中。
2.  封装帧。主机A上的协议软件通过在数据前附加互联网包头和LAN1的帧头，创建了一个LAN1的帧。
3.  LAN1适配器复制帧到网络上。
4.  当帧到达路由器时，路由器的LAN1适配器从电缆上读取它，并把它传送到协议软件。
5.  解封装，路由寻址。路由器从互联网包头中提取出目的地址，并用它作为路由表的索引，确定发送该包的方向（端口）。
6.  路由器的LAN2适配器复制该帧到网络。
7.  当帧到达主机B，其适配器从电缆读到该帧，并传送到协议软件。
8.  解封装。主机B上的协议软件剥落包头和帧头。当服务器进行一个读取这些数据的系统调用时，协议软件最终将得到的数据复制到服务器的虚拟地址空间。

封装->解封装

# 全球IP因特网

因特网是最著名和最成功的互联网实现。

每台因特网主机都运行实现TCP/IP协议。

IP协议提供最基本的命名方法和递送机制，是在主机间传送的。

因特网可以看做一个世界范围的主机集合，满足特性：

+   主机集合被映射为一组32位的IP地址。
+   该组IP地址被映射为一组因特网域名的标识符。
+   因特网主机上的进程能够通过连接和任何其它因特网主机上的进程通信。

IPv4使用32位地址，IPv6使用128位地址。

IP使用点分十进制表示法来表示，如47.102.120.167

因特网域名采用一种将域名映射到IP地址的机制。这种映射是通过分布世界范围内的数据库来维护的，这个数据库是DNS（Domain Name System，域名系统）。DNS数据库由上百万的主机条目结构组成，其中每条定义了一组域名和一组IP地址之间的映射。

域名集合形成了一个类似树的一种层次结构，第一层是一个未命名的根节点，第二组是一组一级域名，包括com、edu、gov、org、net，下一层是二级域名，如cmu.edu。

每台主机都有本地域名localhost，这个域名总是映射为回送地址127.0.0.1。多个域名可以映射为同一个IP地址。多个域名可以映射到同一组的多个IP地址。

因特网客户端和服务器的连接，从连接一个进程的意义上而言，是点对点的；从数据可以同时双向流动的角度而言，是全双工的。

一个套接字是连接的一个端点。每个套接字都有相应的套接字地址，由一个因特网地址和一个16位的整数端口组成的，用“地址 : 端口”表示。

客户端套接字地址中的端口是由内核自动分配的，称为临时端口；而服务器套接字地址中的端口是某个特定端口和该服务相对应的，基本是固定的。

一个连接由其两端的套接字地址唯一确定，这对套接字地址称为套接字对，由下列元组表示：

```shell
(cliaddr : cliport, servaddr : servport)
```

# 套接字接口

套接字接口是一组函数，它们和Unix I/O函数结合起来，用以创建网络应用。