# Elasticsearch 运维

## X-pack

功能提供包括安全性（基于角色的访问，特权/权限，角色和用户安 全性），监视，报告，警报等。

## 分析器

Elasticsearch Analyzer 的类型为内置分析器和自定义分析器。

内置分析器：

- **Standard Analyzer**：标准分析器是默认分词器，如果未指定，则使用该分词器。 它基于 Unicode 文本分割算法，适用于大多数语言。
- **Whitespace Analyzer**：基于空格字符切词。
- **Stop Analyzer**：在 simple Analyzer 的基础上，移除停用词。
- **Keyword Analyzer**：不切词，将输入的整个串一起返回。

## Q&A

### Elasticsearch 在部署时，对 Linux 的设置有哪些优化方法？

- 关闭缓存 swap;
- 堆内存设置为：`Min（节点内存/2, 32GB）`;
- 设置最大文件句柄数；
- 线程池+队列大小根据业务需要做调整；
- 磁盘存储 raid 方式——存储有条件使用 RAID10，增加单节点性能以及避 免单节点存储故障。

### 为什么需要关闭 swap？

一、先明确：ES 对内存的依赖逻辑

ES 的核心工作（索引、搜索、聚合）需要大量内存支撑，且对内存延迟极其敏感，主要依赖两类内存区域：

1. **JVM 堆内存**：用于存储 ES 的核心数据结构（如倒排索引的元数据、搜索上下文、聚合结果等），默认最大不超过 31GB（避免 JVM 垃圾回收效率下降）。
2. **系统页缓存（Page Cache）**：用于缓存 ES 的索引文件（如 `.segments` 倒排索引文件），ES 会主动利用系统空闲内存加速文件读写（无需通过 JVM 堆，减少 GC 压力）。

无论是 JVM 堆还是系统页缓存，其性能前提都是**数据常驻内存**—— 一旦内存不足触发 Swap，数据会被 “交换” 到磁盘，而磁盘的读写延迟（毫秒级）是内存（纳秒级）的 **10 万倍以上**，直接击穿 ES 的性能底线。

二、开启 Swap 对 ES 的 4 大核心危害

Swap 的本质是 “用磁盘空间模拟内存”，但这种 “模拟” 完全不适合 ES 的内存需求，具体危害如下：

1. 性能断崖式下降：从 “毫秒级响应” 变 “秒级 / 分钟级阻塞”。ES 的设计目标是 “近实时搜索（NRT）”，搜索 / 聚合响应通常在毫秒级。若开启 Swap：
   - 当 JVM 堆内存不足时，JVM 可能将部分堆数据交换到磁盘（即 “堆 Swap”），后续访问这些数据时需要从磁盘读回内存，单次操作延迟从 **纳秒级→毫秒级**，直接导致搜索响应超时。
   - 当系统页缓存不足时，ES 缓存的索引文件会被 Swap 到磁盘，后续查询需要重新从磁盘加载索引，原本 “内存命中” 的快速查询变成 “磁盘 IO 密集型” 操作，吞吐量暴跌（例如 QPS 从 1000 降至 10）。

2. JVM 垃圾回收（GC）灾难：Full GC 超时甚至进程崩溃。JVM 的垃圾回收（尤其是 Full GC）需要遍历内存中的对象，若部分对象被 Swap 到磁盘：
   - GC 线程需要从磁盘读取 Swap 中的对象数据，导致 Full GC 时间从 “秒级” 延长到 “分钟级”（甚至更久）。
   - ES 对 GC 时间有严格容忍度（默认超过 30 秒会触发节点 “假死”），长时间 Full GC 会导致节点与集群断开连接，被判定为 “故障节点”，进而引发分片重分配（进一步消耗资源）。
   - 极端情况下，GC 过程中频繁的磁盘 IO 会导致 JVM 进程无响应，最终被系统 kill（OOM 或超时）。

3. 集群稳定性失控：分片重分配与脑裂风险。当 Swap 导致部分节点性能骤降或假死后，ES 集群会触发 “分片重分配”：
    - 集群会将故障节点上的主分片迁移到其他节点，迁移过程需要大量网络 IO 和磁盘 IO（复制索引文件），进一步加剧集群资源紧张。
    - 若多个节点同时因 Swap 假死，集群可能出现 “主节点选举频繁” 甚至 “脑裂”（多个节点同时认为自己是主节点），导致集群无法正常写入数据。

4. 问题排查困难：隐藏真实内存瓶颈。开启 Swap 后，系统的 “内存不足” 问题会被 “掩盖”—— 表面上系统内存使用率未达 100%（因为部分数据被 Swap 到磁盘），但实际可用内存已耗尽，导致运维人员无法快速定位 “内存不足” 的根本原因（例如误判为 “CPU 不足” 或 “磁盘 IO 不足”）。

三、为什么 “关闭 Swap” 是最优解？（而非 “减少 Swap 使用率”）

有人可能会问：“能否保留 Swap 但限制使用率？” 答案是 **不建议**，原因如下：

1. **ES 对内存延迟零容忍**：即使是 “少量 Swap”（如 1% 的内存被交换到磁盘），也可能导致关键路径的查询延迟飙升，无法通过 “限制比例” 规避风险。

2. 内存不足的正确处理方式是 “扩容” 而非 “Swap”

   ：若 ES 触发内存不足，本质原因是 “内存资源无法满足业务需求”，正确的解决方案是：

   - 优化 JVM 堆配置（如将堆内存调整到 26GB，预留更多系统内存给页缓存）。
   - 增加节点数量（横向扩容）或提升单节点内存配置（纵向扩容），而非依赖 Swap 苟延残喘。

3. **Linux 系统的 Swap 策略无法精准适配 ES**：Linux 的 `swappiness` 参数（控制内存交换倾向）即使设置为 0（理论上 “仅内存不足时才 Swap”），也无法完全避免内核在内存压力下触发 Swap（例如内核认为某些内存页 “长期未使用” 而主动交换），无法从根本上消除风险。
