## 三次握手

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e92d0ebc-7d46-413b-aec1-34a39602f787.png)

## 四次挥手

![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f87afe72-c2df-4c12-ac03-9b8d581a8af8.jpg)

client 和 server

为什么不是一次挥手？
如果客户端只发送一次结束帧，那么可能有以下几种情况：

1. 服务器未收到帧，而服务器还处于可发送信息的“半连接”状态，那么仍旧会发送数据给客户端。而此时客户端已经“跑路”了，那么服务器的数据就不知道怎么发送了；而如果很快另起了一个客户端B，同样的端口，那么服务器的数据就会错误地发给客户端B。
2. 服务器收到了帧，如果客户端直接“跑路”了，而服务器还有工作没处理完，这就会强制停止工作
3. 服务器收到了帧，但客户端不知道服务器是否收到，因为怕还会有数据传回来，那么就会一直等，不停发送结束帧，而此时服务器已经关闭了，那么传送的帧就会错误。

为什么不是二次挥手？
1. 如果服务器还有工作未处理完，要等到处理完后才发送确认结束的“挥手”，那么时间会滞留过长，在此过程中，客户端会误以为未收到而持续发送结束帧
2. 如果服务器还有工作未处理完而直接“挥手”，客户端收到确认后直接关闭，那么服务器还是会陷入“半连接”状态

为什么不是三次挥手？
服务器要保证客户端已经收到了结束通知，而避免客户端一直等待服务器处理完工作。如果只挥手三次，那么服务器就不知道客户端是否收到了结束通知

## Q&A

1.  **UDP 和 TCP 的区别**

    TCP：面向连接、字节流，传输可靠（保证数据正确性，保证数据顺序）、适合传输大量数据（流模式）、速度慢，建立连接需要开销较多（时间，系统资源），有拥塞控制（会自己限制自己的速度）和流量控制，只能一对一通信。

    UDP：面向非连接、传输不可靠（尽最大努力交付）、用于传输少量数据(数据包模式)，可以一对一、一对多、多对一、多对多。

2.  **为什么是三次握手（而不是两次？第三次作用是什么？）**

    答：**第三次握手是为了防止服务端因为之前滞留的连接建立请求（即第一次握手） 而建立连接，造成资源浪费**

    解释：

    客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。

    若只有两次握手，那么如果客户端之前曾发过的第一次握手，在网络中因为延迟阻塞了，但结果在第二次发送连接请求建立连接之后到达了服务器，那么服务器会再创建一个（多余的）连接。

    采用三次握手的方式，第三次握手才真正建立连接，可以让服务端不建立多余的连接，节省资源。此时，即便客户端发的第一次握手请求被延迟发送到了服务端，服务端的响应之后，客户端也不会再发第三次握手了，所以不会建立多余连接。

3.  **三次握手都有哪些用？**

    +   确保连通性
    +   得知对方的初始序号
    +   协定流量控制窗口和 MSL（最大报文存活时间，Maximum Segment Lifetime） 长度。

4.  **为什么要四次挥手？**

    客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

    ……

5.  **TCP四次挥手之后为什么要有 `TIME_WAIT`？**

    `TIME_WAIT`等待的是2倍的 IP 数据报在网络中可存活的最大时间（2MSL）。理由：

    -   确保最后一个确认报文（服务端发送的连接释放确认）能够到达。如果服务端没收到客户端发送来的确认报文，那么就会重新发送连接释放请求报文，客户端等待一段时间就是为了处理这种情况的发生。
    -   等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

6.  **TCP 如何保证“可靠”？**

    TCP 保证数据可靠性的方式大致可以分为三类：

    +   在数据包层面：校验和
    +   在数据包传输层面：序列号、确认应答、超时重传、快重传
    +   在流量控制层面：拥塞控制

7.  **TCP各个状态作用：**

    -   CLOSE WAIT https://huoding.com/2016/01/19/488

    -   TIME WAIT https://huoding.com/2013/12/31/316

8.  **TCP 长连接和短连接有什么区别？**
    TCP 短连接是指客户端与服务端连接后只进行一次读写就关闭连接，一般是客户端关闭。
    而长连接则是指在进行完一次读写后不关闭连接，直到服务端压力过大则选择关闭一些长时间为进行读写的连接。

    TCP 短连接的优点在于管理简单，而且不会对服务端造成太大的压力，而缺点是每次读写都需要连接耗时较长。

    TCP 长连接的优点是可以迅速进行多次读写，缺点是对服务端压力大，且容易被恶意连接影响服务。

    长短连接的区别就在于客户端和服务端选择的关闭策略不同，具体需要根据应用场景来选择合适的策略。

## 参考

-   [CS-Notes](http://www.cyc2018.xyz/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E4%BC%A0%E8%BE%93%E5%B1%82.html)
-   [面试问题详解——TCP](https://leetcode-cn.com/circle/discuss/aqTOW4/)



