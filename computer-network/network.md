# 计算机网络

[toc]

# 网络概论

网络：

+   电信网络
+   有线电视网络
+   计算机网络

平时熟称的网络就是指计算机网络

互联网的两个重要特点：连通性和共享性



互联网发展阶段

第一阶段：单体网络ARPANET

第二阶段：三级网络结构（主干网、地区网、企业网/校园网）

第三阶段：多层次ISP结构

ISP（Internet Service Provider）互联网服务提供者，提供网络服务的主体，如提供校园网的高校

IXP（Internet Exchange Point）互联网交换点



互联网由边缘部分和核心部分组成：

+   边缘部分：用户直接使用的主机
+   核心部分：大量网络和连接的路由器组成



用户端系统之间通信的方式：

+   C/S（client-service客户端-服务器）
+   P2P（peer-to-peer，对等方式）：一台主机既可以是客户端也可是服务器，多台主机之间的关系是平等的

路由器是一种用于分组交换的专用计算机

交换方式：

+   电路交换，如电话
+   报文交换
+   分组交换

网络分类

按作用范围分类：

+   广域网，WAN（Wide Area Network）：几十到几千公里
+   城域网，MAN（Metropolitan Area Network）：5-50km，一般为一个城市
+   局域网，LAN（Local Area Network）：1km左右，校园网或企业网属于多个互连的局域网
+   个人区域网，PAN（Personal AreaNetwork）：10m左右

按网络使用者分类：

+   公用网
+   专用网

## 概念

码元：指一个**固定时长**的**信号波形**，代表不同离散数值的基本波形，是数字通信中数字信号的计量单位。该时长内的信号称为k进制码元，该时长称为码元宽度。一般高低电平表示的数字信号为二进制码元。1码元可以携带多个比特的信息量。

速率：数据率，数据的**传输速率**（不是传播速率），分为码元传输速率和信息传输速率，（一般指信息传输速率）

+   码元传输速率：1s传输的码元数（1码元可能携带多个比特），单位为波特（Baud）
+   信息传输速率：1s传输的比特数，单位为bit/s或bps。

带宽：网络中某通道传输数据的能力，即在单位时间内通道所能通过的**最高速率**，单位为bit/s或bps

吞吐量：单位时间内通过某个网络的实际数据量，单位为bit/s、帧/s

# 物理层

物理层要解决的是如何在连接各种计算机的传输媒体上传输数据比特流，而不是具体的物理设备。

物理层的任务是确定与传输媒体接口有关的一些特性，即标准的定义

+   机械特性
+   电气特性
+   功能特性
+   规程特性

##　信道

信道：信号的传输媒介

信号：

+   基带信号：**来自信源**的信号（比如人发出的声音），在数字信道上传输（基带传输）
+   宽带信号：将基带信号进行调制，把信号的频率提高到较高的频率，避免传输距离过远造成信号的衰减。在模拟信道上传输（宽带传输）

数据可以转换成数字信号和模拟信号。转换成数字信号的过程称为**编码**，转换为模拟信号的过程称为**调制**

数字数据（计算机）可通过调制器转换为模拟信号，也可转为数字信号，模拟数据（声音）可通过PCM编码器转换为数字信号，也可转为模拟信号。

编码方式是人为规定的，常用的有：

+   非归零编码：高电平对应1，低电平对应0
+   归零编码：信号电平在一个码元内都要归为0
+   反向不归零编码：信号电平发生变化为0，不发生变化为1
+   曼彻斯特编码：一个码元分为间隔相等的两部分，前高后低为1，前低后高为0（按具体规定，也可相反）
+   差分曼彻斯特编码：在每个码元中间都有一个跳变，同1异0（指下一个码元）
+   4B/5B编码

调制技术，在发送端将数字信号转为模拟信号（调制），在发送端将模拟信号转为数字信号（解调）：

+   调幅，ASK
+   调频，FSK
+   调相，PSK
+   调幅+调相，QAM

信道利用率：发送方在一个发送周期内，有效地发送数据所需要的时间（因为有延时）占整个发送周期的比率。

## 传输媒介

传输媒介/传输媒体/传输介质，是数据通信系统中数据发送端和接收端之间的物理通路，并不属于物理层的范畴，而在物理层之下。

传输媒介分为导引性传输媒介和非导引性传输媒介。

导向性传输介质：

+   双绞线：按有无屏蔽层可分为屏蔽双绞线和非屏蔽双绞线
+   同轴电缆
+   光纤：光纤通信就是利用光导纤维传递**光脉冲**来进行通信。可分为多模光纤和单模光纤。

非导向型传输介质：

+   无线电波：信号向所有方向传播，较强穿透能力
+   微波：信号固定方向传播
    +   地面微波接力通信：地面中继站
    +   卫星通信：同步卫星，三个即可覆盖全球，但传播时延较高
+   红外线、激光：固定方向，需要把传输的信号转换成各自的信号格式

## 信道复用技术

多路复用技术：把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备共享信道资源，提高信道利用率。

+   频分复用FDM
+   时分复用TDM
+   统计时分复用
+   波分复用WDM
+   码分复用CDM

# 数据链路层

## 基本概念

**结点**：主机、路由器

**链路**：网络中两个结点之间的**物理通道**

**数据链路**：网络中两个结点之间的**逻辑通道**，把实现**控制数据传输协议的硬件**和软件加加到链路上就构成了数据链路。

**帧**：链路层的协议数据单元，封装网络层的数据报

数据链路层的任务就是通过一条链路从一个结点向另一个物理链路相邻的结点传输数据报。

具体的功能有：

+   为网络层提供服务：无确认无连接服务，有确认无连接服务，有确认有连接服务
+   链路管理：连接的建立、维持、释放（用于面向连接的服务）
+   组帧
+   流量控制：限制发送方
+   差错控制（帧错/位错）

## 封装成帧

封装成帧就是在一段数据报的首尾添加首部和尾部，以构成一个帧。首部和尾部包含许多的控制信息，其作用便是用于帧定界（确定帧的界限）。

每个数据链路层协议都规定了所能传送的帧的**数据部分的长度上限**，即**最大传送单元**（**MTU**，Maximum Transfer Unit）

组帧的四种方法：

+   字符计数法：帧首部使用一个计数字段来标明帧内字符数/字节数
+   **字符（节）填充法**：在数据中含有首尾部控制字符的前面填充一个字节/字符，通常为转义字符
+   **零比特填充法**：在连续的5个1之后填充一个0，（5“1”1“0”）
+   **违规编码法**：利用两个在（物理层）编码方式（如曼彻斯特编码）中不会用到的编码来界定帧的起始和终止

透明传输，指不管所传数据是什么样的比特组合，都应当能够在链路上传送，链路层看不见任何妨碍数据传输的东西。

当所传数据中的比特组合与某个控制信息一样时，就需要采取某些措施，来避免错误地“截断”帧。

## 差错控制

传输中的差错都是由噪声引起的

+   全局性噪声：由于线路本身电气特性锁产生的随机噪声（热噪声），信道固有且随机存在的。解决办法是提高信噪比。
+   局部性噪声：外界特定的短暂原因所造成的冲击噪声。解决方法是利用编码技术。

差错有：

+   位错（比特差错）：比特位出错，1变成0，0变成1
+   帧错：丢失、重复、失序

在数据链路层中的差错控制主要解决的是比特差错的问题，解决方法有：

+   检错编码：奇偶校验码、**循环冗余码CRC**
+   纠错编码：海明码

ps：上述“编码”是指数据链路层的编码，与物理层的编码不同，它针对的是一组比特，而不是物理层编码针对的单个比特。

使用CRC检验能够实现“无比特差错”的传输，但不能一定实现“无传输差错”，并不是可靠的传输。

## 流量控制

流量控制就是限制发送方的流量发送速率。

数据链路层流量控制功能的应用场景：当较高的发送速度和较低的接收能力不匹配时，会造成传输出错。

传输层也有流量控制的功能，它们的区别：

+   对象不同：数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的。
+   控制手段不同：数据链路层，接收方收不下就不回复确认；传输层，接收端给发送端一个窗口公告。

流量控制的方法：

+   停止-等待协议
+   滑动窗口协议：后退N帧协议（GBN）、选择重传协议（SR）

停止-等待协议很好理解，就是发送端发送一个帧，然后等待接收方的确认，收到确认之后才会再次发送。虽然原理简单，但是信道利用率很低。

滑动窗口协议就是允许发送发传输一串连续的（位于窗口内的）帧，当接收方收到帧时回复确认，当发送方收到窗口最左侧的帧时，窗口就向右滑动，将新的要发送的帧纳入窗口中。

>   PS：滑动窗口的大小/长度是固定的，不会在传输过程中发生变化

GBN协议中，对n号帧的确认采用**累积确认**的方式，标明接收方已经收到n号帧和它之前的全部帧。发送方是异步发送的，接收方是同步的，只能一个个按序接收，比如：接收方已收到1号帧，然后下一个要接收的是2号帧，但却先收到3号帧，不是期望的帧，因此将其丢弃，继续等待2号帧。发送方有一个计时器，如果未收到2号帧的ACK确认，超过预设时间，那么就会重新发送2号帧以及之后的帧（即便3号帧已经发送过了，即相当于窗口后退..）。发送窗口最大为2^n^-1（n为比特位），接收窗口为1。

GBN因连续发送数据帧而提高了信道利用率，但在重传时必须把原来已经正确传送的帧重传，使得传送效率降低。

SR就是针对GBN的一个必须批量重传的弊端进行的一个改进。发送窗口和接收窗口的长度相等，为2^(n-1)^。接收方会对已接收到的、但失序的、且在窗口内的帧进行一个缓存。发送方只重传出错的帧，发送方每一个帧都有一个单独的计时器，超时未收到确认时重新发送。

## 介质访问控制

数据链路层的信道分为：

+   点对点信道/链路：适用于**广域网**，应有有PPP协议
+   广播信道/链路：适用于**局域网**，应用有早期的总线以太网、无线局域网，典型的拓扑结构有总线型、环形网和星形网

广播信道（局域网）需要介质访问控制技术来避免相互节点发生通信干扰。

介质访问控制（Medium access control，MAC）：采取一定措施，使得两对节点之间的通信不会发生互相干扰的情况。

介质访问控制分类：

+   静态划分信道（信道划分MAC）
    +   频分多路复用FDM
    +   时分多路复用TDM、统计时分复用STDM
    +   波分多路复用WDM
    +   码分多路复用CDM
+   动态分配信道（动态媒体接入控制、多点接入）
    +   **轮询访问**MAC（受控接入）：令牌传递协议
    +   **随机访问**MAC（随机接入）：
        +   ALOHA协议：随机发送，想发就发（想说就说），容易冲突，效率低，吞吐量小
        +   CSMA协议：发送之前先监听信道（先听再说）
        +   CSMA/CD协议
        +   CSMA/CA协议

信道划分介质访问控制：将使用介质的每个设备与来自同一信道上的其它设备的通信隔离开，把时域和频域资源合理地分配给网络上的设备。基于多路复用技术划分资源。预先分配。

多点接入：信道并非在用户通信时固定分配给用户

随机接入：所有用户可随时发送信息，且发送时占全部带宽

### CSMA

CSMA，载波监听多点接入协议：

>   CS：每一个站点在发送数据前和发送数据时都要检测一下总线上是否有其它计算机在发送数据
>
>   MA：多个计算机以多点接入的方式连接在一根总线上。（总线型网络）
>
>   检测方法：根据总线上的信号电压摆动值大小，当超过一定门限值时，就认定有多个站点在发送数据

CSMA在发送帧之前会先监听信道，如果信道空闲，就发送完整的帧，如果信道繁忙，则推迟发送。根据具体实现措施的不同，分为1-坚持CSMA、非坚持CSMA和p-坚持CSMA三种。

|          | 1-坚持CSMA   | 非坚持CSMA             | p-坚持CSMA                                   |
| -------- | ------------ | ---------------------- | -------------------------------------------- |
| 信道空闲 | 马上发送     | 马上发送               | p概率马上发，<br>1-p概率等到下一个时间片再发 |
| 信道忙   | 继续坚持监听 | 等下一个随机事件再监听 | 等下一个随机时间再监听                       |

### CSMA/CD

CSMA/CD，载波监听多点接入/碰撞检测（carrier sense multiple access with collision detection）

>   CD：碰撞检测，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其它站点是否也在发送数据

### CSMA/CA

载波监听多点接入/碰撞避免，CSMA/CA（carrier sense multiple access with collision avoidance）

检测方式：采用能量检测（ED）、载波检测（CS）和能量载波混合检测三种检测信道的方式

CSMA/CA常用于无线局域网，而CSMA/CD用于有限局域网（总线式以太网）

## 局域网

拓扑结构：总线型、星形、环形、树形

分类：

+   以太网：应用最广泛的局域网，采用IEEE 802.3标准，逻辑拓扑是总线型，物理拓扑是星形
+   令牌环网：逻辑拓扑是环形，物理拓扑是星形，采用IEEE 802.5标准
+   FDDI网
+   ATM网
+   无线局域网（Wireless Local Area Network，WLAN）：传输介质是电磁波，采用IEEE 802.11标准；WIFI只是其的一个应用，无线局域网的作用范围比WIFI更广

IEEE 802标准将数据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层

+   LLC：为网络层提供服务
+   MAC：为物理层提供服务

### 以太网

以太网（Ethernet）是一个基带总线局域网规范，是当今现有局域网采用的最通用的通信协议标准，采用CSMA/CD技术

以太网造价低廉，网络速率位于10Mb/s-10Gb/s

以太网有DIX Ethernet V2和IEEE 802.3两个标准

以太网提供的是无连接、不可靠的服务 



适配器（网卡）：连接计算机和外界的有线局域网

适配器上装有RAM和ROM，ROM上有计算机硬件的MAC地址

MAC地址（物理地址），全球唯一的48位二进制地址（多用6个十六进制数表示），前24位代表厂家

高速以太网：

+   100BASE-T以太网
+   吉比特以太网
+   10吉比特以太网

## 广域网

广域网的范围是地区级的，从几十公里到几千公里，实际就是利用一些设备（如节点交换机）将各个局域网或计算机系统互连起来，强调的目的是**资源共享**。因特网（互联网）就是世界范围内最大的广域网。

广域网的通信子网主要使用**分组交换**技术。

主要的协议是PPP协议和HDLC协议

PPP协议只支持全双工通信，组成：

+   一个将数据报封装到串行链路的方法
+   链路控制协议LCP
+   网络控制协议NCP

## 设备

网桥：根据MAC帧的目的地址对帧进行**转发**和**过滤**，只有两个接口。

交换机：实质是一个多接口的网桥，内部的转发表（地址表）是通过**自学习**算法自行建立起来的。连接交换机的设备可以独占传输媒体的带宽，无碰撞地传输数据。

冲突域：同一时间内只能有一台设备发送信息的范围

广播域：如果站点发出一个信号，所有能接收到这个信号的设备范围

|                              | 隔离冲突域 | 隔离广播域 |
| ---------------------------- | ---------- | ---------- |
| 物理层设备（中继器、集线器） | 否         | 否         |
| 链路层设备（网桥、交换机）   | 可         | 否         |
| 网络层设备（路由器）         | 可         | 可         |

# 网络层

网络层的主要任务是把**分组**从源端传到目的端，为分组交换网上的不同主机提供通信服务。

功能：

+   路由选择与分组转发
+   异构网络互联
+   拥塞控制

虚电路

## 网际协议IP

### 分类的IP地址

IP地址 ::= {<网络号>,<主机号>}，常用**点分十进制**来表示

+   A类（1-126）
+   B类（128-191）
+   C类（192-223）
+   D类（224-239）：多播地址
+   E类（240-255）：保留为今后使用

缺点：

+   地址空间的利用率有时很低
+   两级IP地址不够灵活

### 子网划分

IP ::= {<网络号>，<子网号>，<主机号>}

子网掩码：网络号和子网号全为1，主机好全为0

将子网掩码和IP地址逐位相与，可以求出网络地址

此时的路由表有三列：源地址、目的地址、子网掩码

使用子网时路由器的分组转发过程：

1.  提取目的IP地址
2.  判断是否直接交付
3.  是否含有其目的地址的特定主机路由
4.  检测路由表中有无路径
5.  默认路由0.0.0.0
6.  报告转发分组出错

### 无分类编址CIDR

CIDR（Classless Inter-Domain Routing），无分类路由选择

IP ::= {<网络前缀>，<主机号>}

斜线记法：在IP地址后加上"/"，表示网络前缀所占的位数

特点：

+   消除了传统的A类、B类和C类地址及子网划分的概念
+   融合子网地址与子网掩码，方便子网划分：把网络前缀都相同的连续的IP地址组成一个CIDR地址块

很容易根据地址块获取主机最大地址和最小地址，获取CIDR地址掩码（子网掩码）

构成超网/路由聚合：将网络前缀长度减小，以将多个子网聚合成一个较大的子网，减少路由表中的数目

在超网中寻址使用**最长前缀匹配**模式

## 路由选择协议

路由选择算法分类：

+   静态路由算法（非自适应路由算法）：手工配置路由信息
+   动态路由算法（自适应路由算法）：路由器彼此交换信息
    +   全局性，链路状态路由算法OSPF：所有路由器掌握完整的网络拓扑和连路费用信息
    +   分散性，距离向量路由算法RIP：路由器只掌握物理相连的邻居及链路费用

路由选择协议：

+   内部网关协议IGP：RIP、OSPF
+   外部网关协议EGP：BGP

## ARP协议

作用：完成IP地址到MAC地址的映射， 根据IP地址查找目的主机的MAC地址

+   使用高速缓存
+   广播搜索MAC地址

## ICMP协议

作用：差错或异常报告

ICMP报文被封装在IP数据报的数据部分，前4个字节是统一的格式：类型、代码和检验和

主要分为ICMP差错报文和ICMP询问报文

+   CMP差错报文：
    +   终点不可达
    +   时间超过
    +   参数问题
    +   改变路由（重定向）

+   ICMP询问报文：
    +   回送请求或回答：PING（packet InterNet Groper）命令的应用
    +   时间戳请求或回答

## IPv6

IPv6数据报由**基本首部**和**有效载荷**两部分组成

变化：

1.  地址空间：128位
2.  首部长度固定40字节
3.  校验和字段移除，减少每跳的时间
4.  首部长度必须为8字节的整数倍，Ipv4是4字节对齐
5.  支持即插即用（自动配置），即不需要DHCP来为主机自动配置
6.  支持资源的预分配，支持实时视像等要求保证一定的带宽和时延的应用
7.  IPv6只能在主机上分片，IPv4可以在路由器和主机分片
8.  使用ICMPv6

IPv6的基本类型地址：

+   单播：一对一通信，可做源地址和目的地址
+   多播：包括广播，一对多通信，可做目的地址
+   任播：一对多中的一个通信（距离最近的），可做目的地址

IPv6的地址采用**冒号十六进制记法**，对一串连续的零可采用**零压缩**方式，但只能压缩一次，否则无法区分多个压缩段中0的个数

```markdown
冒号十六进制 ==> FF05:0:0:0:CD30:0:0:0
零压缩 ==> FF05::CD30:0:0:0 或 FF05:0:0:0:CD30::
```

IPv4向IPv6过渡的策略：

+   **双栈协议**：同时启用IPv4协议栈和IPv6协议栈
+   **隧道技术**：隧道协议将其它协议的数据帧或包重新封装然后通过隧道发送，如在IPv4的路由器中将IPv6的帧重新封装成一个IPv4的帧，IPv6的帧作为其数据字段

在IPv6中，地址解析协议ARP和网际组管理协议IGMP的功能都被合并到**ICMPv6**中，即在网络层中只有ICMPv6和IPv6两个协议

## IP组播



# 应用层

## DNS域名系统

每一个域名都是唯一的，有其唯一的层次结构，使用域的命名空间来唯一标识一个域名。域在命名空间中可被管理、划分，一个域其下可划分有子域（一级域、二级域等）。

以`ccnu.edu.cn`为例，`cn`为顶级域名，`edu`为二级域名，`ccnu`为三级域名。

每个域名都由有`.`隔开的标号（英文字母、数字或`-`）组成，英文字母不区分大小写。每个标号不超过63个字符，由多个标号组成的域名总共不超过255个字符。

顶级域名TLD（Top Level Domain）：

+   国家顶级域名ccTLD
+   通用顶级域名nTLD
+   基础结构域名：只有一个arpa，用于反向域名解析，称为反向域名

中国把二级域名划分为类别域名和行政区域名两大类，类别域名有edu、gov、ac（科研机构）等七个。

DNS服务器以**区**为管辖范围，区的划分可以任意。区的范围一定小于或等于域。

域名服务器分为：

+   根域名服务器
+   顶级域名服务器
+   权限域名服务器：每个区的域名服务器称为**权限域名服务器**，用来保存该区所有主机到IP地址的映射。
+   本地域名服务器：不能说每台用户主机就是一个本地域名服务器，而是距离用户主机最近的一个默认域名服务器，只是不超过几个路由器的距离。

域名服务器会有主域名服务器和辅助域名服务器，来提高服务器的可靠性。

域名解析过程：

+   主机向本地域名服务器发起**递归查询**。
+   本地域名服务器向**根域名服务器**发起**迭代查询**或**递归查询**。

域名服务器中广泛使用**高速缓存**，以减轻根域名服务器的载荷和减少互联网上的DNS查询报文的数量。主机也有使用缓存。

## 文件传输协议FTP

文件传输协议主要有FTP、TFTP（Trivial File Transfer Protocol，简单文件传输协议）。FTP使用TCP连接，TFTP使用UDP连接。

## 动态主机配置协议DHCP

动态主机配置协议DHCP，使用客户端/服务器方式，客户端和服务端通过**广播**方式进行交互，基于**UDP**

DHCP提供即插即用联网的机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关，允许地址重用，支持移动用户加入网络，支持在用地址续租

流程：

1.  主机广播DHCP**发现**报文
2.  DHCP服务器广播DHCP**提供**报文
3.  主机广播DHCP**请求**报文
4.  DHCP服务器广播DHCP**确认**报文



